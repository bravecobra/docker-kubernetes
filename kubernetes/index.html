
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Setting up a bare metal Kubernetes cluster on VMWare's ESXi">
      
      
        <meta name="author" content="Giovanni Van Geel">
      
      
      
        <link rel="prev" href="../esxi/">
      
      
        <link rel="next" href="../kubectl/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>Setup the cluster - Bare-metal Kubernetes experiment</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kubernetes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Bare-metal Kubernetes experiment" class="md-header__button md-logo" aria-label="Bare-metal Kubernetes experiment" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Bare-metal Kubernetes experiment
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Setup the cluster
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/bravecobra/docker-kubernetes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    bravecobra/docker-kubernetes
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Bare-metal Kubernetes experiment" class="md-nav__button md-logo" aria-label="Bare-metal Kubernetes experiment" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Bare-metal Kubernetes experiment
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bravecobra/docker-kubernetes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    bravecobra/docker-kubernetes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../esxi/" class="md-nav__link">
        Setting up ESXi
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Setup the cluster
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Setup the cluster
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#create-kubernetes-nodes" class="md-nav__link">
    Create Kubernetes nodes
  </a>
  
    <nav class="md-nav" aria-label="Create Kubernetes nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare-networking" class="md-nav__link">
    Prepare networking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-vm-machines" class="md-nav__link">
    Creating VM machines
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-software" class="md-nav__link">
    Install software
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tweak-ubuntu-settings" class="md-nav__link">
    Tweak Ubuntu Settings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-dns-entries" class="md-nav__link">
    Add DNS entries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-kubernetes" class="md-nav__link">
    Setup kubernetes
  </a>
  
    <nav class="md-nav" aria-label="Setup kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup-the-master-node" class="md-nav__link">
    Setup the master node
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-the-worker-nodes" class="md-nav__link">
    Add the worker nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-install" class="md-nav__link">
    Post install
  </a>
  
    <nav class="md-nav" aria-label="Post install">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#remote-kubectl" class="md-nav__link">
    Remote Kubectl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-login-for-private-repositories" class="md-nav__link">
    Docker login for private repositories
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metallb" class="md-nav__link">
    MetalLb
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pull-private-images" class="md-nav__link">
    Pull private images
  </a>
  
    <nav class="md-nav" aria-label="Pull private images">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#footnotes" class="md-nav__link">
    Footnotes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../kubectl/" class="md-nav__link">
        Accessing the cluster
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../dashboard/" class="md-nav__link">
        Basic UI
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../helm/" class="md-nav__link">
        Adding Helm
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../rancher/" class="md-nav__link">
        Adding Rancher
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#create-kubernetes-nodes" class="md-nav__link">
    Create Kubernetes nodes
  </a>
  
    <nav class="md-nav" aria-label="Create Kubernetes nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare-networking" class="md-nav__link">
    Prepare networking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-vm-machines" class="md-nav__link">
    Creating VM machines
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-software" class="md-nav__link">
    Install software
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tweak-ubuntu-settings" class="md-nav__link">
    Tweak Ubuntu Settings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-dns-entries" class="md-nav__link">
    Add DNS entries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-kubernetes" class="md-nav__link">
    Setup kubernetes
  </a>
  
    <nav class="md-nav" aria-label="Setup kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup-the-master-node" class="md-nav__link">
    Setup the master node
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-the-worker-nodes" class="md-nav__link">
    Add the worker nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-install" class="md-nav__link">
    Post install
  </a>
  
    <nav class="md-nav" aria-label="Post install">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#remote-kubectl" class="md-nav__link">
    Remote Kubectl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-login-for-private-repositories" class="md-nav__link">
    Docker login for private repositories
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metallb" class="md-nav__link">
    MetalLb
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pull-private-images" class="md-nav__link">
    Pull private images
  </a>
  
    <nav class="md-nav" aria-label="Pull private images">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#footnotes" class="md-nav__link">
    Footnotes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="kubernetes">Kubernetes</h1>
<h2 id="create-kubernetes-nodes">Create Kubernetes nodes</h2>
<h3 id="prepare-networking">Prepare networking</h3>
<p>I added 3 MAC addresses to my router's DHCP settings, so that each machine would get the same IP from the DHCP server</p>
<p><img alt="Router" src="../images/Router.png" /></p>
<p>Next I added 3 new virtual machines, based on the <a href="http://releases.ubuntu.com/18.04/">Ubuntu server 18.04 ISO</a>. Each machine was configured the same way, except for the MAC address of course.</p>
<h3 id="creating-vm-machines">Creating VM machines</h3>
<p>Create 3 virtual machine with the following specs:</p>
<p><img alt="Machine Specs" src="../images/Machine_Specs.png" /></p>
<p>Add the Ubuntu ISO to the CD drive, which I downloaded from the site, then uploaded to the datastore.</p>
<p>Boot up each machine and just follow the installer of ubuntu server, accepting the defaults. I added the OpenSSH server and imported my github key so I didn't needed to setup ssh access any further.</p>
<p><img alt="Install1" src="../images/Install1.png" />
<img alt="Install2" src="../images/Install2.png" />
<img alt="Install3" src="../images/Install3.png" />
<img alt="Install4" src="../images/Install4.png" />
<img alt="Install5" src="../images/Install5.png" />
<img alt="Install6" src="../images/Install6.png" />
<img alt="Install7" src="../images/Install7.png" />
<img alt="Install8" src="../images/Install8.png" />
<img alt="Install9" src="../images/Install9.png" />
<img alt="Install10" src="../images/Install10.png" />
<img alt="Install11" src="../images/Install11.png" />
<img alt="Install12" src="../images/Install12.png" />
<img alt="Install13" src="../images/Install13.png" />
<img alt="Install14" src="../images/Install14.png" /></p>
<p>Then SSH into each machine in a separate terminal.</p>
<pre><code class="language-powershell">ssh 192.168.0.200
ssh 192.168.0.199
ssh 192.168.0.198
</code></pre>
<p>Next verify each machines ip address</p>
<pre><code class="language-bash">sudo ip addr
</code></pre>
<h3 id="install-software">Install software</h3>
<p>Next install docker</p>
<pre><code class="language-bash">sudo apt-get update
sudo apt-get install -y docker.io
</code></pre>
<p>Next installer the kubernetes cli tools</p>
<pre><code class="language-bash">sudo apt-get update &amp;&amp; sudo apt-get install -y apt-transport-https curl
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
sudo cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list
deb http://apt.kubernetes.io/ kubernetes-xenial main
EOF
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
</code></pre>
<p>You need to install these on all the VMs.</p>
<h3 id="tweak-ubuntu-settings">Tweak Ubuntu Settings</h3>
<p>Disabling swap</p>
<pre><code class="language-bash">sudo swapoff -a
</code></pre>
<p>Comment out the swap file in <code>/etc/fstab</code></p>
<pre><code class="language-bash">sudo nano /etc/fstab
</code></pre>
<p><img alt="swap" src="../images/swap.png" /></p>
<p>Then delete the swap file</p>
<pre><code class="language-bash">sudo rm -f /swap.img
</code></pre>
<pre><code class="language-bash">sudo systemctl enable docker.service
</code></pre>
<h3 id="add-dns-entries">Add DNS entries</h3>
<pre><code class="language-bash">sudo nano /etc/hosts
</code></pre>
<p>and add the following</p>
<pre><code class="language-hosts">&lt;vm-ip&gt; &lt;vm-name&gt; &lt;vm-name&gt;.olympus.home
&lt;vm-ip&gt; rancher rancher.olympus.home
</code></pre>
<h2 id="setup-kubernetes">Setup kubernetes</h2>
<h3 id="setup-the-master-node">Setup the master node</h3>
<p>On the master node initialize the cluster.</p>
<pre><code class="language-bash">sudo kubeadm init
</code></pre>
<p><img alt="KubernetesJoin" src="../images/Kubernetes_Join.png" /></p>
<p>Run the proposed commands on the master</p>
<pre><code class="language-bash">mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>
<p><code>kubeadm</code> does a lot of the heavy lifting required to setup a Kubernetes Cluster like installing a CA, generating certificates, installing and configuring <code>etcd</code>, getting addons like <code>CoreDNS</code>, <code>kube-proxy</code>. But one thing that is does not do is install a networking addon. For Kubernetes to work you need to have a pod network add-on. There are a lot of CNI providers and you can choose any of them. I chose Weave Net as it does not require any additional configuration. You install it on the Master node by running</p>
<pre><code class="language-bash">kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')&quot;
</code></pre>
<h3 id="add-the-worker-nodes">Add the worker nodes</h3>
<p>Use the following command on each of the worker nodes</p>
<pre><code class="language-bash">kubeadm join 192.168.0.200:6443 --token 5auxv4.26************90 --discovery-token-ca-cert-hash sha256:01e5ef2c************************************************6a4ff89564
</code></pre>
<p>If you ever need to reconstruct this command, check out the <a href="https://blog.scottlowe.org/2019/08/15/reconstructing-the-join-command-for-kubeadm/">blog post of Scott Lowe</a>.</p>
<p>At this point your Kubernetes Cluster is up and running. You can use the <code>kubectl</code> command from the Master node to query the cluster information.</p>
<pre><code class="language-bash">kubectl cluster-info
kubectl get nodes
</code></pre>
<p><img alt="Kubernetes-Up" src="../images/Kubernetes-Up.png" /></p>
<pre><code class="language-bash">kubectl describe nodes
</code></pre>
<p>Once all are in the ready state we have a working Kubernetes cluster with 3 nodes (one master node and 2 worker nodes).</p>
<h3 id="post-install">Post install</h3>
<h4 id="remote-kubectl">Remote Kubectl</h4>
<p>we have <code>kubectl</code> once we ssh into the master node, but we might want to get the same access from an external machine. To do so, we copy the <code>~/.kube/config</code> to our local machine and add it to our local <code>KUBECONFIG</code> env variable.</p>
<pre><code class="language-bash">scp your-username@192.168.0.200:/home/your-username/.kube/config C:/Users/your-username/.kube/config-esxi-kubernetes
</code></pre>
<p>More on this in <a href="../kubectl/">kubectl configuration</a></p>
<h4 id="docker-login-for-private-repositories">Docker login for private repositories</h4>
<p>To have the cluster be able to pull docker images from a private repository, refer to the <a href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/#registry-secret-existing-credentials">documentation</a>.</p>
<p>A <code>docker login</code> however will not store the credentials in the <code>config.json</code> as it is insecure, however you can easily create that credential as that's just the base64 encoded string of the username and password for the registry. Note that for github's package registry your password is to be a personal token, not the credentials you use to login.</p>
<pre><code class="language-powershell">[Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes('$DOCKERHUB_USER:$DOCKERHUB_PASSWORD'))
</code></pre>
<p>or</p>
<pre><code class="language-bash">echo -n '$DOCKERHUB_USER:$DOCKERHUB_PASSWD' | base64
</code></pre>
<p>and use the output in <code>config.json</code></p>
<pre><code class="language-json">{
   &quot;auths&quot;: {
        &quot;https://index.docker.io/v1/&quot;: {
            &quot;auth&quot;: &quot;$BASE64_STRING&quot;
        }
    }
}
</code></pre>
<blockquote>
<p><strong><em>WARNING</em></strong> Base64 is NOT encryption and should never be considered safe!</p>
</blockquote>
<h3 id="metallb">MetalLb</h3>
<p>Since we're runnig on a BareMetal cluster (not on Azure, GCE, AWS, ...), the loadbalancers don't get an IP assigned. Kubernetes doesn't offer that out of the box. A solution for this is <a href="https://metallb.universe.tf/installation/">MetalLB</a></p>
<pre><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/google/metallb/v0.8.3/manifests/metallb.yaml
</code></pre>
<p>Then provide a config</p>
<pre><code class="language-bash">kubectl apply -f ./src/kubernetes/metallb.yaml
</code></pre>
<p>Now each time a resource of type load balancer is started, MetalLB will assign it an external IP from the pool it was given.</p>
<h3 id="pull-private-images">Pull private images</h3>
<p>Basically follow the <a href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/">kubernetes documentation</a>.</p>
<p>Make sure your docker's <code>config.json</code> contains the secret.</p>
<pre><code class="language-json">{
    &quot;auths&quot;: {
        &quot;https://index.docker.io/v1/&quot;: {
            &quot;auth&quot;: &quot;c3R...zE2&quot;
        }
    }
}
</code></pre>
<blockquote>
<p><strong><em>NOTE:</em></strong>  In case of github package registry, you use a personal token as the password to give access to your registries.</p>
</blockquote>
<p>Add a secret with those docker credentials to your cluster and give it a name like <code>regcred</code>.</p>
<pre><code class="language-bash">kubectl create secret generic regcred --from-file=.dockerconfigjson=C:/Users/&lt;username&gt;/.docker/config.json --type=kubernetes.io/dockerconfigjson
</code></pre>
<p>Then use that secret by name as part of your deployment</p>
<pre><code class="language-yaml">spec:
    containers:
    image: private-image:1.0
    imagePullPolicy: IfNotPresent
    name: private-image
    imagePullSecrets:
    - name: regcred
    restartPolicy: Always
</code></pre>
<h4 id="footnotes">Footnotes</h4>
<p><a href="http://vijayshinva.github.io/kubernetes/2018/07/28/setting-up-a-kubernetes-cluster-on-a-windows-laptop-using-hyper-v.html">Reference</a></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2020 Giovanni Van Geel
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/bravecobra" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/bravecobra" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://www.linkedin.com/in/giovanni-van-geel" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
    
  </body>
</html>